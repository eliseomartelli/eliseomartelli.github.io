---
title: Nebula, a simple overlay networking tool
categories: networking
---

VPNs are one of the preferred ways to tie-up multiple servers (and clients) together, but their nature becomes a **bottleneck** when the infrastructure to *link* becomes larger.  
A solution to this problem comes in the form of a software defined network **(SDN)**.

[**Nebula**](https://github.com/slackhq/nebula) (from SlackHQ) addresses this problem by providing software that helps you build a point-to-point network between devices that can be situated (almost) anywhere in the world!

The communication between devices is encrypted using the [Noise Protocol Framework](https://noiseprotocol.org/), the same used by Signal.

And you know what's great? Nebula is completely **open source!**

## Nebula Vocabolary

Nebula's vocabolary is not so different from normal networking, you should only get accostumed to two terms:
- lighthouse;
- node.

**Lighthouse** is the term used by Nebula to address **nodes** that are publicly routable.  
A node connects first to the **lighthouse**, then it discovers the most efficent path to reach other nodes on the network.

## Configuring Nebula

Let's get to the fun part!

As stated earlier, to run a Nebula Lighthouse you need a machine with a publicly routable IP address, if you don't have one, a little 5$ Droplet on [DigitalOcean](https://m.do.co/c/33e2f0a1e231) will do just fine.  
This guide will show you how to run nebula as a regular user, in constrast with the official documentation that assumes you will run nebula as the root user.

On the machines you'd like to attach to Nebula, you need to download the binary from the release page on GitHub and then extract it using *tar*.
```bash
$ curl -OL https://github.com/slackhq/nebula/releases/download/v1.2.0/nebula-linux-amd64.tar.gz
$ tar xzvf nebula-linux-amd64.tar.gz
```

Now you need to move the Nebula binary to /usr/bin/ and set the right permissions.   
You can do it manually or you can use the [*install*](https://man.cx/install) command.
```bash
# install ./nebula /usr/bin
```

Since we don't want to run Nebula as root, it's the right time to add a *system* user (so it's hidden from your login manager) for Nebula.  
This new user doesn't need a *home* directory, so we're instructing the *useradd* command to not create one.
```bash
#Â useradd --system --no-create-home nebula
```

Following the [Filesystem Hierarchy Standard](https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard) that states that configuration files should reside in the /etc directory, we're going to create the directories to store configuration files and certificates that are related to Nebula.
```bash
# mkdir /etc/nebula
# mkdir /etc/nebula/certs
```

To instantiate a Nebula network you have to generate a Nebula Certificate authority, preferably on another host so you can keep your private key secure. Remember to copy the certificate to your hosts!
```bash
$ ./nebula-cert ca -name "My really cool organization"
$ scp ca.crt user@<hostname>:/etc/nebula/certs
```
Make sure to keep the ca.key file in a safe place, you will need it if you want to add other hosts to your network.

Generate a keypair for each host you'd like to connect to your Nebula network and copy the pair to your Nebula's hosts:
```bash
$ ./nebula-cert sign -name "mylighthouse" -ip "192.168.100.1/24"
$ scp mylighthouse.crt user@<hostname>:/etc/nebula/certs
$ scp mylighthouse.key user@<hostname>:/etc/nebula/certs
```

Configure Nebula by editing /etc/nebula/config.yml:

On the lighthouse node:
```yaml
pki:
  ca: /etc/nebula/certs/ca.crt
  cert: /etc/nebula/certs/mylighthouse.crt
  key: /etc/nebula/certs/mylighthouse.key

lighthouse:
  am_lighthouse: true

listen:
  host: 0.0.0.0
  port: 4242

punchy:
  punch: true

tun:
  dev: nebula1
  drop_local_broadcast: false
  drop_multicast: false
  tx_queue: 500
  mtu: 1300
  routes:
  unsafe_routes:

firewall:
  conntrack:
    tcp_timeout: 120h
    udp_timeout: 3m
    default_timeout: 10m
    max_connections: 100000

  outbound:
    # Allow all outbound traffic from this node
    - port: any
      proto: any
      host: any

  inbound:
    # Allow icmp between any nebula hosts
    - port: any
      proto: icmp
      host: any
```

On the other nodes:
```yaml
pki:
  ca: /etc/nebula/certs/ca.crt
  cert: /etc/nebula/certs/mynode.crt
  key: /etc/nebula/certs/mynode.key
  
static_host_map:
  "192.168.100.1": ["<lighthouse_public_ip>:4242"]

punchy:
  punch: true

tun:
  dev: nebula1
  drop_local_broadcast: false
  drop_multicast: false
  tx_queue: 500
  mtu: 1300
  routes:
  unsafe_routes:

firewall:
  conntrack:
    tcp_timeout: 120h
    udp_timeout: 3m
    default_timeout: 10m
    max_connections: 100000

  outbound:
    # Allow all outbound traffic from this node
    - port: any
      proto: any
      host: any

  inbound:
    # Allow icmp between any nebula hosts
    - port: any
      proto: icmp
      host: any
```

8. Change the ownership of the /etc/nebula folder and its contents and set the right permissions to the certificates:
```bash
# chown -R nebula:nebula /etc/nebula
# chmod 600 /etc/nebula/certs/*
```

9. Add the NET_CAP_ADMIN capability to the nebula binary so you can run it as a non-root user:
```bash
# setcap cap_net_admin=+pe /usr/bin/nebula
```

10. Try running Nebula with the nebula user:
```bash
# su nebula
$ nebula -config /etc/nebula/config.yml
```

11. (Optional) Add a Systemd unit to run Nebula as a service:
/etc/systemd/system/nebula.service
```
[Unit]
Description=Nebula Service
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=1
User=nebula
ExecStart=/usr/bin/nebula -config /etc/nebula/config.yml

[Install]
WantedBy=multi-user.target
```

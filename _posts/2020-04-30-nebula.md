---
title: Nebula, a simple overlay networking tool
categories: networking
---

VPNs are one of the preferred ways to tie-up multiple servers (and clients) together, but their nature becomes a **bottleneck** when the infrastructure to *link* becomes larger.  
A solution to this problem comes in the form of a software defined network **(SDN)**.

[**Nebula**](https://github.com/slackhq/nebula) (from SlackHQ) addresses this problem by providing software that helps you build a point-to-point network between devices that can be situated (almost) anywhere in the world!

The communication between devices is encrypted using the [Noise Protocol Framework](https://noiseprotocol.org/), the same used by Signal.

And you know what's great? Nebula is completely **open source!**

## Nebula Vocabolary

Nebula's vocabolary is not so different from normal networking, you should only get accostumed to two terms:
- lighthouse;
- node.

**Lighthouse** is the term used by Nebula to address **nodes** that are publicly routable.  
A node connects first to the **lighthouse**, then it discovers the most efficent path to reach other nodes on the network.

## Configuring Nebula

Let's get to the fun part!

As stated earlier, to run a Nebula Lighthouse you need a machine with a publicly routable IP address, if you don't have one, a little 5$ Droplet on [DigitalOcean](https://m.do.co/c/33e2f0a1e231) will do just fine.

1. On the machines you'd like to attach to Nebula, you need to download the binary from the release page on GitHub and then extract it using *tar*.
```bash
$ curl -OL https://github.com/slackhq/nebula/releases/download/v1.2.0/nebula-linux-amd64.tar.gz
$ tar xzvf nebula-linux-amd64.tar.gz
```

2. Install *nebula* in /usr/bin:
```bash
# install ./nebula /usr/bin
```

3. Add a *system* user for nebula:

```bash
#Â useradd --system --no-create-home nebula
```

4. Create the folders to store the configuration files and certificates of Nebula:
```bash
# mkdir /etc/nebula
# mkdir /etc/nebula/certs
```

5. Generate a Nebula Certificate authority and copy it to your nebula's hosts:
```bash
$ ./nebula-cert ca -name "My really cool organization"
$ scp ca.crt user@<hostname>:/etc/nebula/certs
```
Make sure to keep the ca.key file in a safe place, you will need it if you want to add other hosts to your network.

6. Generate a keypair for each host you'd like to connect to your nebula network and copy the pair to your nebula's hosts:
```bash
$ ./nebula-cert sign -name "mylighthouse" -ip "192.168.100.1/24"
$ scp mylighthouse.crt user@<hostname>:/etc/nebula/certs
$ scp mylighthouse.key user@<hostname>:/etc/nebula/certs
```

7. Configure Nebula by editing /etc/nebula/config.yml:

On the lighthouse node:
```yaml
pki:
  ca: /etc/nebula/certs/ca.crt
  cert: /etc/nebula/certs/mylighthouse.crt
  key: /etc/nebula/certs/mylighthouse.key

lighthouse:
  am_lighthouse: true

listen:
  host: 0.0.0.0
  port: 4242

punchy:
  punch: true

tun:
  dev: nebula1
  drop_local_broadcast: false
  drop_multicast: false
  tx_queue: 500
  mtu: 1300
  routes:
  unsafe_routes:

firewall:
  conntrack:
    tcp_timeout: 120h
    udp_timeout: 3m
    default_timeout: 10m
    max_connections: 100000

  outbound:
    # Allow all outbound traffic from this node
    - port: any
      proto: any
      host: any

  inbound:
    # Allow icmp between any nebula hosts
    - port: any
      proto: icmp
      host: any
```

On the other nodes:
```yaml
pki:
  ca: /etc/nebula/certs/ca.crt
  cert: /etc/nebula/certs/mynode.crt
  key: /etc/nebula/certs/mynode.key
  
static_host_map:
  "192.168.100.1": ["<lighthouse_public_ip>:4242"]

punchy:
  punch: true

tun:
  dev: nebula1
  drop_local_broadcast: false
  drop_multicast: false
  tx_queue: 500
  mtu: 1300
  routes:
  unsafe_routes:

firewall:
  conntrack:
    tcp_timeout: 120h
    udp_timeout: 3m
    default_timeout: 10m
    max_connections: 100000

  outbound:
    # Allow all outbound traffic from this node
    - port: any
      proto: any
      host: any

  inbound:
    # Allow icmp between any nebula hosts
    - port: any
      proto: icmp
      host: any
```

8. Change the ownership of the /etc/nebula folder and its contents and set the right permissions to the certificates:
```bash
# chown -R nebula:nebula /etc/nebula
# chmod 600 /etc/nebula/certs/*
```

9. Add the NET_CAP_ADMIN capability to the nebula binary so you can run it as a non-root user:
```bash
# setcap cap_net_admin=+pe /usr/bin/nebula
```

10. Try running Nebula with the nebula user:
```bash
# su nebula
$ nebula -config /etc/nebula/config.yml
```

11. (Optional) Add a Systemd unit to run Nebula as a service:
/etc/systemd/system/nebula.service
```
[Unit]
Description=Nebula Service
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=1
User=nebula
ExecStart=/usr/bin/nebula -config /etc/nebula/config.yml

[Install]
WantedBy=multi-user.target
```
